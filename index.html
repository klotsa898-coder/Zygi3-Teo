<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeping Pro - 6 Fields & History</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #ffffff; --accent: #1a73e8; --border: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        
        /* ÎšÎµÎ½Ï„ÏÎ¹ÎºÏŒ Banner 24h */
        .main-yield-banner { background: linear-gradient(135deg, #1e1e1e, #2d2d2d); padding: 20px; border-radius: 15px; margin-bottom: 15px; text-align: center; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .main-yield-val { font-size: 2.8em; font-weight: bold; }
        .main-yield-label { font-size: 0.7em; color: #888; letter-spacing: 1px; margin-bottom: 5px; text-transform: uppercase; }

        /* Banner Î™ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï 7 Î—Î¼ÎµÏÏÎ½ */
        .history-container { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px; padding-bottom: 10px; scrollbar-width: thin; }
        .history-day { background: var(--card); min-width: 85px; padding: 12px 8px; border-radius: 12px; border: 1px solid var(--border); text-align: center; flex: 1; }
        .hist-date { font-size: 0.65em; color: #888; margin-bottom: 4px; }
        .hist-val { font-size: 1em; font-weight: bold; }

        .last-update { font-size: 0.75em; color: #ffca28; text-align: center; margin-bottom: 10px; background: #252525; padding: 8px; border-radius: 10px; border: 1px solid #444; }
        
        .toolbar { background: var(--card); padding: 10px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        
        .grid-container { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media(min-width: 600px) { .grid-container { grid-template-columns: 1fr 1fr; } }
        
        .card { background: var(--card); border-radius: 15px; padding: 15px; border-top: 5px solid var(--accent); }
        .header-flex { display: flex; justify-content: space-between; align-items: center; }
        h3 { margin: 0; font-size: 0.85em; color: #888; text-transform: uppercase; }
        .value-display { font-size: 2.2em; font-weight: bold; margin: 5px 0; display: flex; align-items: baseline; }
        .stats-row { display: flex; gap: 10px; font-size: 0.75em; color: #777; margin-bottom: 10px; border-top: 1px solid #2a2a2a; padding-top: 5px; }
        .chart-box { width: 100%; height: 160px; }
        select { background: #333; color: white; border: none; padding: 8px; border-radius: 8px; font-size: 11px; }
    </style>
</head>
<body>

    <div class="main-yield-banner">
        <div class="main-yield-label">Î”Î™Î‘Î¦ÎŸÎ¡Î‘ 24Î© (21:00-21:00)</div>
        <div id="24hYieldMain" class="main-yield-val">--</div>
    </div>

    <div style="font-size: 0.7em; color: #888; margin-bottom: 5px; text-align: center; text-transform: uppercase;">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ 7 Î—Î¼ÎµÏÏÎ½ (gr)</div>
    <div class="history-container" id="historyLog"></div>

    <div class="last-update" id="mainUpdate">ğŸ•’ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>

    <div class="toolbar">
        <span style="font-size: 0.75em; color: #888;">Î•ÏÏÎ¿Ï‚ Î“ÏÎ±Ï†Î®Î¼Î±Ï„Î¿Ï‚:</span>
        <select id="resultsRange" onchange="loadData()">
            <option value="10">10 Î¼ÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚</option>
            <option value="20" selected>20 Î¼ÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚</option>
            <option value="50">50 Î¼ÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚</option>
        </select>
    </div>

    <div id="dashboard" class="grid-container"></div>

    <script>
        const channelID = '2099480'; 
        const readAPIKey = '8RQ7ZGRY4TCX14O1';

        const fieldConfig = {
            'field1': { label: 'Î’Î¬ÏÎ¿Ï‚', unit: 'gr', icon: 'âš–ï¸', color: '#ff5252', decimals: 0 },
            'field2': { label: 'Î¥Î³ÏÎ±ÏƒÎ¯Î±', unit: '%', icon: 'ğŸ’§', color: '#448aff', decimals: 1 },
            'field3': { label: 'Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±', unit: 'Â°C', icon: 'ğŸŒ¡ï¸', color: '#4caf50', decimals: 1 },
            'field4': { label: 'ÎœÏ€Î±Ï„Î±ÏÎ¯Î±', unit: 'V', icon: 'ğŸ”‹', color: '#ffc107', decimals: 2 },
            'field5': { label: 'Î”Î¹Î±Ï†Î¿ÏÎ¬ (gr)', unit: 'gr', icon: 'ğŸ“‰', color: '#ff4081', decimals: 0 },
            'field6': { label: 'GSM Signal', unit: 'dBm', icon: 'ğŸ“¶', color: '#00bcd4', decimals: 0 }
        };

        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(() => { loadData(); updateHivesInfo(); });

        async function updateHivesInfo() {
            try {
                const res = await fetch(`https://api.thingspeak.com/channels/${channelID}/fields/1.json?api_key=${readAPIKey}&results=800`);
                const data = await res.json();
                const feeds = data.feeds;
                if(!feeds.length) return;

                const getWeightAt21 = (date) => {
                    const target = new Date(date);
                    target.setHours(21, 0, 0);
                    const closest = feeds.reduce((prev, curr) => 
                        Math.abs(new Date(curr.created_at) - target) < Math.abs(new Date(prev.created_at) - target) ? curr : prev
                    );
                    return parseFloat(closest.field1);
                };

                // ÎšÎµÎ½Ï„ÏÎ¹ÎºÏŒ Banner (gr)
                const wToday = getWeightAt21(new Date());
                const wYest = getWeightAt21(new Date().setDate(new Date().getDate()-1));
                const diffMain = (wToday - wYest).toFixed(0);
                const mainEl = document.getElementById('24hYieldMain');
                mainEl.innerText = `${diffMain > 0 ? '+' : ''}${diffMain} gr`;
                mainEl.style.color = diffMain >= 0 ? '#4caf50' : '#ff5252';

                // Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ 7 Î·Î¼ÎµÏÏÎ½ (gr)
                const historyLog = document.getElementById('historyLog');
                historyLog.innerHTML = '';
                for (let i = 0; i < 7; i++) {
                    const d0 = new Date(); d0.setDate(d0.getDate() - i);
                    const d1 = new Date(); d1.setDate(d1.getDate() - (i + 1));
                    const diff = (getWeightAt21(d0) - getWeightAt21(d1)).toFixed(0);
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'history-day';
                    dayDiv.innerHTML = `
                        <div class="hist-date">${d0.toLocaleDateString('el-GR', {weekday:'short', day:'numeric'})}</div>
                        <div class="hist-val" style="color:${diff >= 0 ? '#4caf50' : '#ff5252'}">${diff > 0 ? '+' : ''}${diff}g</div>
                    `;
                    historyLog.appendChild(dayDiv);
                }
            } catch(e) { console.error(e); }
        }

        function loadData() {
            const num = document.getElementById('resultsRange').value;
            fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=${num}`)
            .then(res => res.json()).then(data => {
                if(!data.feeds || data.feeds.length === 0) return;
                const lastFeed = data.feeds[data.feeds.length - 1];
                const lastDate = new Date(lastFeed.created_at);
                document.getElementById('mainUpdate').innerText = `ğŸ•’ Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î¼Î­Ï„ÏÎ·ÏƒÎ·: ${lastDate.toLocaleDateString('el-GR')} | ${lastDate.toLocaleTimeString('el-GR', {hour:'2-digit', minute:'2-digit'})}`;

                const dashboard = document.getElementById('dashboard');
                dashboard.innerHTML = '';
                
                Object.keys(fieldConfig).forEach(key => {
                    const conf = fieldConfig[key];
                    const vals = data.feeds.map(f => parseFloat(f[key])).filter(v => !isNaN(v));
                    if(vals.length === 0) return;

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="header-flex"><h3>${conf.label}</h3><span>${conf.icon}</span></div>
                        <div class="value-display" style="color:${conf.color}">
                            ${vals[vals.length-1].toFixed(conf.decimals)}<span style="font-size:0.4em; color:#666; margin-left:5px;">${conf.unit || ''}</span>
                        </div>
                        <div class="stats-row">
                            <span>MIN: ${Math.min(...vals).toFixed(conf.decimals)}</span>
                            <span>MAX: ${Math.max(...vals).toFixed(conf.decimals)}</span>
                        </div>
                        <div id="chart_${key}" class="chart-box"></div>
                    `;
                    dashboard.appendChild(card);
                    drawChart(data.feeds, key, conf.label, conf.color);
                });
            });
        }

        function drawChart(feeds, key, label, color) {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Time');
            dataTable.addColumn('number', label);
            feeds.forEach(f => {
                let v = parseFloat(f[key]);
                if (!isNaN(v)) dataTable.addRow([new Date(f.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), v]);
            });
            new google.visualization.LineChart(document.getElementById('chart_'+key)).draw(dataTable, {
                backgroundColor: 'transparent', curveType: 'function', legend: 'none',
                pointSize: 5, 
                hAxis: { textPosition: 'none' }, vAxis: { gridlines: {color:'#2a2a2a'}, textStyle: {color:'#555'} },
                colors: [color], chartArea: {width:'95%', height:'80%'}
            });
        }
        setInterval(() => { loadData(); updateHivesInfo(); }, 60000);
    </script>
</body>
      </html>
      
